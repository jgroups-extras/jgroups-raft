<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Asciidoctor 2.0.23">
    <meta name="author" content="Bela Ban &lt;belaban@yahoo.com&gt;">
    <title>Distributed consensus with JGroups Raft</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
    <style>
        /*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
        /* Uncomment the following line when using as a custom stylesheet */
        /* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
        html{font-family:sans-serif;-webkit-text-size-adjust:100%}
        a{background:none}
        a:focus{outline:thin dotted}
        a:active,a:hover{outline:0}
        h1{font-size:2em;margin:.67em 0}
        b,strong{font-weight:bold}
        abbr{font-size:.9em}
        abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
        dfn{font-style:italic}
        hr{height:0}
        mark{background:#ff0;color:#000}
        code,kbd,pre,samp{font-family:monospace;font-size:1em}
        pre{white-space:pre-wrap}
        q{quotes:"\201C" "\201D" "\2018" "\2019"}
        small{font-size:80%}
        sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
        sup{top:-.5em}
        sub{bottom:-.25em}
        img{border:0}
        svg:not(:root){overflow:hidden}
        figure{margin:0}
        audio,video{display:inline-block}
        audio:not([controls]){display:none;height:0}
        fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
        legend{border:0;padding:0}
        button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
        button,input{line-height:normal}
        button,select{text-transform:none}
        button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
        button[disabled],html input[disabled]{cursor:default}
        input[type=checkbox],input[type=radio]{padding:0}
        button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
        textarea{overflow:auto;vertical-align:top}
        table{border-collapse:collapse;border-spacing:0}
        *,::before,::after{box-sizing:border-box}
        html,body{font-size:100%}
        body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
        a:hover{cursor:pointer}
        img,object,embed{max-width:100%;height:auto}
        object,embed{height:100%}
        img{-ms-interpolation-mode:bicubic}
        .left{float:left!important}
        .right{float:right!important}
        .text-left{text-align:left!important}
        .text-right{text-align:right!important}
        .text-center{text-align:center!important}
        .text-justify{text-align:justify!important}
        .hide{display:none}
        img,object,svg{display:inline-block;vertical-align:middle}
        textarea{height:auto;min-height:50px}
        select{width:100%}
        .subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
        div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
        a{color:#2156a5;text-decoration:underline;line-height:inherit}
        a:hover,a:focus{color:#1d4b8f}
        a img{border:0}
        p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
        p aside{font-size:.875em;line-height:1.35;font-style:italic}
        h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
        h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
        h1{font-size:2.125em}
        h2{font-size:1.6875em}
        h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
        h4,h5{font-size:1.125em}
        h6{font-size:1em}
        hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
        em,i{font-style:italic;line-height:inherit}
        strong,b{font-weight:bold;line-height:inherit}
        small{font-size:60%;line-height:inherit}
        code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
        ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
        ul,ol{margin-left:1.5em}
        ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
        ul.circle{list-style-type:circle}
        ul.disc{list-style-type:disc}
        ul.square{list-style-type:square}
        ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
        ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
        dl dt{margin-bottom:.3125em;font-weight:bold}
        dl dd{margin-bottom:1.25em}
        blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
        blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
        @media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
            h1{font-size:2.75em}
            h2{font-size:2.3125em}
            h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
            h4{font-size:1.4375em}}
        table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
        table thead,table tfoot{background:#f7f8f7}
        table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
        table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
        table tr.even,table tr.alt{background:#f8f8f7}
        table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
        h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
        h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
        .center{margin-left:auto;margin-right:auto}
        .stretch{width:100%}
        .clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
        .clearfix::after,.float-group::after{clear:both}
        :not(pre).nobreak{word-wrap:normal}
        :not(pre).nowrap{white-space:nowrap}
        :not(pre).pre-wrap{white-space:pre-wrap}
        :not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
        pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
        pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
        pre>code{display:block}
        pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
        em em{font-style:normal}
        strong strong{font-weight:400}
        .keyseq{color:rgba(51,51,51,.8)}
        kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
        .keyseq kbd:first-child{margin-left:0}
        .keyseq kbd:last-child{margin-right:0}
        .menuseq,.menuref{color:#000}
        .menuseq b:not(.caret),.menuref{font-weight:inherit}
        .menuseq{word-spacing:-.02em}
        .menuseq b.caret{font-size:1.25em;line-height:.8}
        .menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
        b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
        b.button::before{content:"[";padding:0 3px 0 2px}
        b.button::after{content:"]";padding:0 2px 0 3px}
        p a>code:hover{color:rgba(0,0,0,.9)}
        #header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
        #header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
        #header::after,#content::after,#footnotes::after,#footer::after{clear:both}
        #content{margin-top:1.25em}
        #content::before{content:none}
        #header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
        #header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
        #header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
        #header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
        #header .details span:first-child{margin-left:-.125em}
        #header .details span.email a{color:rgba(0,0,0,.85)}
        #header .details br{display:none}
        #header .details br+span::before{content:"\00a0\2013\00a0"}
        #header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
        #header .details br+span#revremark::before{content:"\00a0|\00a0"}
        #header #revnumber{text-transform:capitalize}
        #header #revnumber::after{content:"\00a0"}
        #content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
        #toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
        #toc>ul{margin-left:.125em}
        #toc ul.sectlevel0>li>a{font-style:italic}
        #toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
        #toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
        #toc li{line-height:1.3334;margin-top:.3334em}
        #toc a{text-decoration:none}
        #toc a:active{text-decoration:underline}
        #toctitle{color:#7a2518;font-size:1.2em}
        @media screen and (min-width:768px){#toctitle{font-size:1.375em}
            body.toc2{padding-left:15em;padding-right:0}
            body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
            #toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
            #toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
            #toc.toc2>ul{font-size:.9em;margin-bottom:0}
            #toc.toc2 ul ul{margin-left:0;padding-left:1em}
            #toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
            body.toc2.toc-right{padding-left:0;padding-right:15em}
            body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
        @media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
            #toc.toc2{width:20em}
            #toc.toc2 #toctitle{font-size:1.375em}
            #toc.toc2>ul{font-size:.95em}
            #toc.toc2 ul ul{padding-left:1.25em}
            body.toc2.toc-right{padding-left:0;padding-right:20em}}
        #content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
        #content #toc>:first-child{margin-top:0}
        #content #toc>:last-child{margin-bottom:0}
        #footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
        #footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
        #content{margin-bottom:.625em}
        .sect1{padding-bottom:.625em}
        @media screen and (min-width:768px){#content{margin-bottom:1.25em}
            .sect1{padding-bottom:1.25em}}
        .sect1:last-child{padding-bottom:0}
        .sect1+.sect1{border-top:1px solid #e7e7e9}
        #content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
        #content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
        #content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
        #content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
        #content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
        details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
        details{margin-left:1.25rem}
        details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
        details>summary::-webkit-details-marker{display:none}
        details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
        details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
        details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
        .admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
        table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
        .paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
        .admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
        .admonitionblock>table td.icon{text-align:center;width:80px}
        .admonitionblock>table td.icon img{max-width:none}
        .admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
        .admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
        .admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
        .exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
        .sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
        .sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
        .exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
        .exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
        .literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
        @media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
        @media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
        .literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
        .literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
        .listingblock>.content{position:relative}
        .listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
        .listingblock:hover code[data-lang]::before{display:block}
        .listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
        .listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
        .listingblock pre.highlightjs{padding:0}
        .listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
        .listingblock pre.prettyprint{border-width:0}
        .prettyprint{background:#f7f7f8}
        pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
        pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
        pre.prettyprint li code[data-lang]::before{opacity:1}
        pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
        table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
        table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
        table.linenotable td.code{padding-left:.75em}
        table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
        pre.pygments span.linenos{display:inline-block;margin-right:.75em}
        .quoteblock{margin:0 1em 1.25em 1.5em;display:table}
        .quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
        .quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
        .quoteblock blockquote{margin:0;padding:0;border:0}
        .quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
        .quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
        .quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
        .verseblock{margin:0 1em 1.25em}
        .verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
        .verseblock pre strong{font-weight:400}
        .verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
        .quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
        .quoteblock .attribution br,.verseblock .attribution br{display:none}
        .quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
        .quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
        .quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
        .quoteblock.abstract{margin:0 1em 1.25em;display:block}
        .quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
        .quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
        .quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
        .quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
        .quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
        p.tableblock:last-child{margin-bottom:0}
        td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
        td.tableblock>.content>:last-child{margin-bottom:-1.25em}
        table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
        table.grid-all>*>tr>*{border-width:1px}
        table.grid-cols>*>tr>*{border-width:0 1px}
        table.grid-rows>*>tr>*{border-width:1px 0}
        table.frame-all{border-width:1px}
        table.frame-ends{border-width:1px 0}
        table.frame-sides{border-width:0 1px}
        table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
        table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
        table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
        table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
        table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
        th.halign-left,td.halign-left{text-align:left}
        th.halign-right,td.halign-right{text-align:right}
        th.halign-center,td.halign-center{text-align:center}
        th.valign-top,td.valign-top{vertical-align:top}
        th.valign-bottom,td.valign-bottom{vertical-align:bottom}
        th.valign-middle,td.valign-middle{vertical-align:middle}
        table thead th,table tfoot th{font-weight:bold}
        tbody tr th{background:#f7f8f7}
        tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
        p.tableblock>code:only-child{background:none;padding:0}
        p.tableblock{font-size:1em}
        ol{margin-left:1.75em}
        ul li ol{margin-left:1.5em}
        dl dd{margin-left:1.125em}
        dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
        li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
        ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
        ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
        ul.unstyled,ol.unstyled{margin-left:0}
        li>p:empty:only-child::before{content:"";display:inline-block}
        ul.checklist>li>p:first-child{margin-left:-1em}
        ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
        ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
        ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
        ul.inline>li{margin-left:1.25em}
        .unstyled dl dt{font-weight:400;font-style:normal}
        ol.arabic{list-style-type:decimal}
        ol.decimal{list-style-type:decimal-leading-zero}
        ol.loweralpha{list-style-type:lower-alpha}
        ol.upperalpha{list-style-type:upper-alpha}
        ol.lowerroman{list-style-type:lower-roman}
        ol.upperroman{list-style-type:upper-roman}
        ol.lowergreek{list-style-type:lower-greek}
        .hdlist>table,.colist>table{border:0;background:none}
        .hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
        td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
        td.hdlist1{font-weight:bold;padding-bottom:1.25em}
        td.hdlist2{word-wrap:anywhere}
        .literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
        .colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
        .colist td:not([class]):first-child img{max-width:none}
        .colist td:not([class]):last-child{padding:.25em 0}
        .thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
        .imageblock.left{margin:.25em .625em 1.25em 0}
        .imageblock.right{margin:.25em 0 1.25em .625em}
        .imageblock>.title{margin-bottom:0}
        .imageblock.thumb,.imageblock.th{border-width:6px}
        .imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
        .image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
        .image.left{margin-right:.625em}
        .image.right{margin-left:.625em}
        a.image{text-decoration:none;display:inline-block}
        a.image object{pointer-events:none}
        sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
        sup.footnote a,sup.footnoteref a{text-decoration:none}
        sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
        #footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
        #footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
        #footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
        #footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
        #footnotes .footnote:last-of-type{margin-bottom:0}
        #content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
        div.unbreakable{page-break-inside:avoid}
        .big{font-size:larger}
        .small{font-size:smaller}
        .underline{text-decoration:underline}
        .overline{text-decoration:overline}
        .line-through{text-decoration:line-through}
        .aqua{color:#00bfbf}
        .aqua-background{background:#00fafa}
        .black{color:#000}
        .black-background{background:#000}
        .blue{color:#0000bf}
        .blue-background{background:#0000fa}
        .fuchsia{color:#bf00bf}
        .fuchsia-background{background:#fa00fa}
        .gray{color:#606060}
        .gray-background{background:#7d7d7d}
        .green{color:#006000}
        .green-background{background:#007d00}
        .lime{color:#00bf00}
        .lime-background{background:#00fa00}
        .maroon{color:#600000}
        .maroon-background{background:#7d0000}
        .navy{color:#000060}
        .navy-background{background:#00007d}
        .olive{color:#606000}
        .olive-background{background:#7d7d00}
        .purple{color:#600060}
        .purple-background{background:#7d007d}
        .red{color:#bf0000}
        .red-background{background:#fa0000}
        .silver{color:#909090}
        .silver-background{background:#bcbcbc}
        .teal{color:#006060}
        .teal-background{background:#007d7d}
        .white{color:#bfbfbf}
        .white-background{background:#fafafa}
        .yellow{color:#bfbf00}
        .yellow-background{background:#fafa00}
        span.icon>.fa{cursor:default}
        a span.icon>.fa{cursor:inherit}
        .admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
        .admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
        .admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
        .admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
        .admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
        .admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
        .conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
        .conum[data-value] *{color:#fff!important}
        .conum[data-value]+b{display:none}
        .conum[data-value]::after{content:attr(data-value)}
        pre .conum[data-value]{position:relative;top:-.125em}
        b.conum *{color:inherit!important}
        .conum:not([data-value]):empty{display:none}
        dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
        h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
        p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
        p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
        p{margin-bottom:1.25rem}
        .sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
        .exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
        .print-only{display:none!important}
        @page{margin:1.25cm .75cm}
        @media print{*{box-shadow:none!important;text-shadow:none!important}
            html{font-size:80%}
            a{color:inherit!important;text-decoration:underline!important}
            a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
            a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
            abbr[title]{border-bottom:1px dotted}
            abbr[title]::after{content:" (" attr(title) ")"}
            pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
            thead{display:table-header-group}
            svg{max-width:100%}
            p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
            h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
            #header,#content,#footnotes,#footer{max-width:none}
            #toc,.sidebarblock,.exampleblock>.content{background:none!important}
            #toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
            body.book #header{text-align:center}
            body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
            body.book #header .details{border:0!important;display:block;padding:0!important}
            body.book #header .details span:first-child{margin-left:0!important}
            body.book #header .details br{display:block}
            body.book #header .details br+span::before{content:none!important}
            body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
            body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
            .listingblock code[data-lang]::before{display:block}
            #footer{padding:0 .9375em}
            .hide-on-print{display:none!important}
            .print-only{display:block!important}
            .hide-for-print{display:none!important}
            .show-for-print{display:inherit!important}}
        @media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
            .sect1{padding:0!important}
            .sect1+.sect1{border:0}
            #footer{background:none}
            #footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
        @media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        pre.rouge table td { padding: 5px; }
        pre.rouge table pre { margin: 0; }
        pre.rouge .cm {
            color: #999988;
            font-style: italic;
        }
        pre.rouge .cp {
            color: #999999;
            font-weight: bold;
        }
        pre.rouge .c1 {
            color: #999988;
            font-style: italic;
        }
        pre.rouge .cs {
            color: #999999;
            font-weight: bold;
            font-style: italic;
        }
        pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
            color: #999988;
            font-style: italic;
        }
        pre.rouge .err {
            color: #a61717;
            background-color: #e3d2d2;
        }
        pre.rouge .gd {
            color: #000000;
            background-color: #ffdddd;
        }
        pre.rouge .ge {
            color: #000000;
            font-style: italic;
        }
        pre.rouge .gr {
            color: #aa0000;
        }
        pre.rouge .gh {
            color: #999999;
        }
        pre.rouge .gi {
            color: #000000;
            background-color: #ddffdd;
        }
        pre.rouge .go {
            color: #888888;
        }
        pre.rouge .gp {
            color: #555555;
        }
        pre.rouge .gs {
            font-weight: bold;
        }
        pre.rouge .gu {
            color: #aaaaaa;
        }
        pre.rouge .gt {
            color: #aa0000;
        }
        pre.rouge .kc {
            color: #000000;
            font-weight: bold;
        }
        pre.rouge .kd {
            color: #000000;
            font-weight: bold;
        }
        pre.rouge .kn {
            color: #000000;
            font-weight: bold;
        }
        pre.rouge .kp {
            color: #000000;
            font-weight: bold;
        }
        pre.rouge .kr {
            color: #000000;
            font-weight: bold;
        }
        pre.rouge .kt {
            color: #445588;
            font-weight: bold;
        }
        pre.rouge .k, pre.rouge .kv {
            color: #000000;
            font-weight: bold;
        }
        pre.rouge .mf {
            color: #009999;
        }
        pre.rouge .mh {
            color: #009999;
        }
        pre.rouge .il {
            color: #009999;
        }
        pre.rouge .mi {
            color: #009999;
        }
        pre.rouge .mo {
            color: #009999;
        }
        pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
            color: #009999;
        }
        pre.rouge .sa {
            color: #000000;
            font-weight: bold;
        }
        pre.rouge .sb {
            color: #d14;
        }
        pre.rouge .sc {
            color: #d14;
        }
        pre.rouge .sd {
            color: #d14;
        }
        pre.rouge .s2 {
            color: #d14;
        }
        pre.rouge .se {
            color: #d14;
        }
        pre.rouge .sh {
            color: #d14;
        }
        pre.rouge .si {
            color: #d14;
        }
        pre.rouge .sx {
            color: #d14;
        }
        pre.rouge .sr {
            color: #009926;
        }
        pre.rouge .s1 {
            color: #d14;
        }
        pre.rouge .ss {
            color: #990073;
        }
        pre.rouge .s, pre.rouge .dl {
            color: #d14;
        }
        pre.rouge .na {
            color: #008080;
        }
        pre.rouge .bp {
            color: #999999;
        }
        pre.rouge .nb {
            color: #0086B3;
        }
        pre.rouge .nc {
            color: #445588;
            font-weight: bold;
        }
        pre.rouge .no {
            color: #008080;
        }
        pre.rouge .nd {
            color: #3c5d5d;
            font-weight: bold;
        }
        pre.rouge .ni {
            color: #800080;
        }
        pre.rouge .ne {
            color: #990000;
            font-weight: bold;
        }
        pre.rouge .nf, pre.rouge .fm {
            color: #990000;
            font-weight: bold;
        }
        pre.rouge .nl {
            color: #990000;
            font-weight: bold;
        }
        pre.rouge .nn {
            color: #555555;
        }
        pre.rouge .nt {
            color: #000080;
        }
        pre.rouge .vc {
            color: #008080;
        }
        pre.rouge .vg {
            color: #008080;
        }
        pre.rouge .vi {
            color: #008080;
        }
        pre.rouge .nv, pre.rouge .vm {
            color: #008080;
        }
        pre.rouge .ow {
            color: #000000;
            font-weight: bold;
        }
        pre.rouge .o {
            color: #000000;
            font-weight: bold;
        }
        pre.rouge .w {
            color: #bbbbbb;
        }
        pre.rouge {
            background-color: #f8f8f8;
        }
    </style>
</head>
<body class="article toc2 toc-left">
<div id="header">
    <h1>Distributed consensus with JGroups Raft</h1>
    <div class="details">
        <span id="author" class="author">Bela Ban &lt;belaban@yahoo.com&gt;</span><br>
        <span id="revdate">2025-09-26 21</span>
    </div>
    <div id="toc" class="toc2">
        <div id="toctitle">Table of Contents</div>
        <ul class="sectlevel1">
            <li><a href="#_overview">1. Overview</a>
                <ul class="sectlevel2">
                    <li><a href="#_architecture">1.1. Architecture</a></li>
                </ul>
            </li>
            <li><a href="#_using_jgroups_raft">2. Using jgroups-raft</a>
                <ul class="sectlevel2">
                    <li><a href="#_cluster_members_and_identity">2.1. Cluster members and identity</a></li>
                    <li><a href="#_rafthandle">2.2. RaftHandle</a>
                        <ul class="sectlevel3">
                            <li><a href="#_creation">2.2.1. Creation</a></li>
                            <li><a href="#_making_changes">2.2.2. Making changes</a></li>
                            <li><a href="#_reading_values">2.2.3. Reading values</a></li>
                            <li><a href="#ImplementingStateMachine">2.2.4. Implementing a StateMachine</a></li>
                            <li><a href="#Snapshots">2.2.5. Snapshotting and state transfer</a></li>
                            <li><a href="#_miscellaneous_methods">2.2.6. Miscellaneous methods</a></li>
                        </ul>
                    </li>
                    <li><a href="#_configuration">2.3. Configuration</a></li>
                    <li><a href="#DynamicMembership">2.4. Adding and removing members dynamically</a>
                        <ul class="sectlevel3">
                            <li><a href="#_learner_nodes">2.4.1. Learner nodes</a></li>
                        </ul>
                    </li>
                </ul>
            </li>
            <li><a href="#BuildingBlocks">3. Building blocks</a>
                <ul class="sectlevel2">
                    <li><a href="#ReplicatedStateMachine">3.1. ReplicatedStateMachine</a>
                        <ul class="sectlevel3">
                            <li><a href="#_reads_and_consensus">3.1.1. Reads and consensus</a></li>
                        </ul>
                    </li>
                    <li><a href="#CounterService">3.2. CounterService</a>
                        <ul class="sectlevel3">
                            <li><a href="#_synchronous_counters">3.2.1. Synchronous counters</a></li>
                            <li><a href="#_asynchronous_counters">3.2.2. Asynchronous counters</a></li>
                            <li><a href="#_reads_and_consensus_2">3.2.3. Reads and consensus</a></li>
                            <li><a href="#_ignoring_return_values">3.2.4. Ignoring return values</a></li>
                        </ul>
                    </li>
                    <li><a href="#_cluster_singleton_service">3.3. Cluster singleton service</a></li>
                </ul>
            </li>
            <li><a href="#protlist">4. List of protocols</a>
                <ul class="sectlevel2">
                    <li><a href="#NO_DUPES">4.1. NO_DUPES</a></li>
                    <li><a href="#ELECTION">4.2. ELECTION</a></li>
                    <li><a href="#ELECTION2">4.3. ELECTION2</a></li>
                    <li><a href="#RAFT">4.4. RAFT</a></li>
                    <li><a href="#REDIRECT">4.5. REDIRECT</a></li>
                    <li><a href="#CLIENT">4.6. CLIENT</a></li>
                </ul>
            </li>
            <li><a href="#_migration_guide">5. Migration Guide</a>
                <ul class="sectlevel2">
                    <li><a href="#_1_1_0">5.1. 1.1.0</a>
                        <ul class="sectlevel3">
                            <li><a href="#_leveldblog_is_deprecated">5.1.1. LevelDBLog is deprecated</a></li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
</div>
<div id="content">
    <div id="preamble">
        <div class="sectionbody">
            <div class="paragraph">
                <p>&copy; Red Hat 2014 â€“ 2025</p>
            </div>
            <div class="paragraph">
                <p>This document is licensed under the
                    <a href="http://creativecommons.org/licenses/by-sa/3.0/us/legalcode">"Creative Commons Attribution-ShareAlike (CC-BY-SA) 3.0"</a>
                    license.</p>
            </div>
            <div class="paragraph">
                <p>This is the JGroups Raft manual. It provides information about</p>
            </div>
            <div class="ulist">
                <ul>
                    <li>
                        <p>Design and architecture</p>
                    </li>
                    <li>
                        <p>Configuration and use</p>
                    </li>
                </ul>
            </div>
            <div class="paragraph">
                <p>of jgroups-raft.</p>
            </div>
            <div class="paragraph">
                <p>Bela Ban, Kreuzlingen Switzerland 2017</p>
            </div>
        </div>
    </div>
    <div class="sect1">
        <h2 id="_overview"><a class="anchor" href="#_overview"></a>1. Overview</h2>
        <div class="sectionbody">
            <div class="paragraph">
                <p>The <a href="https://github.com/jgroups-extras/jgroups-raft">jgroups-raft</a> project is an implementation of
                    <a href="https://raftconsensus.github.io/">Raft</a> in <a href="http://www.jgroups.org">JGroups</a>.</p>
            </div>
            <div class="paragraph">
                <p>It provides a consensus based system where leader election and changes are committed by <em>consensus</em> (majority agreement).
                    A fixed number of nodes form a cluster and each node is a state machine. A leader is elected by consensus and all
                    changes happen through the leader which replicates them to all nodes, which add them to their persistent log.</p>
            </div>
            <div class="paragraph">
                <p>Because Raft guarantees that there&#8217;s only ever one leader at any time, and changes are identified uniquely, all state
                    machines receive the same ordered stream of updates and thus have the exact same state.</p>
            </div>
            <div class="paragraph">
                <p>Raft favors <em>consistency</em> over <em>availability</em>; in terms of the <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a>,
                    jgroups-raft is a CP system. This means jgroups-raft is highly consistent, and the data replicated to nodes will never
                    diverge, even in the face of network partitions (split brains), or restarts. Or, on an extended version, jgroups-raft
                    provides the means to build PC/EC systems concerning the <a href="https://en.wikipedia.org/wiki/PACELC_theorem">PACELC theorem</a>.</p>
            </div>
            <div class="paragraph">
                <p>In case of a network partition, in a cluster of <code>N</code> nodes, at least <code>N/2+1</code> nodes have to be running for the
                    system to be available.</p>
            </div>
            <div class="paragraph">
                <p>If for example, in a 5 node cluster, 2 nodes go down, then the system can still commit changes
                    and elect leaders as 3 is still the majority. However, if another node goes down, the system becomes unavailable and client
                    requests will be rejected. (Depending on configuration, there may still be some limited form of read-only availability.)</p>
            </div>
            <div class="paragraph">
                <p>By implementing jgroups-raft in JGroups, the following benefits can be had:</p>
            </div>
            <div class="ulist">
                <ul>
                    <li>
                        <p>Transports already available: UDP, TCP</p>
                        <div class="ulist">
                            <ul>
                                <li>
                                    <p>Contains thread pools, priority delivery (OOB), batching etc</p>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <p>Variety of discovery protocols</p>
                    </li>
                    <li>
                        <p>Encryption, authentication, compression</p>
                    </li>
                    <li>
                        <p>Fragmentation, reliability over UDP</p>
                    </li>
                    <li>
                        <p>Multicasting for larger clusters</p>
                    </li>
                    <li>
                        <p>Failure detection</p>
                    </li>
                    <li>
                        <p>Sync/async cluster RPCs</p>
                    </li>
                </ul>
            </div>
            <div class="paragraph">
                <p>The code required to be written for a full Raft implementation is smaller than if it had been implemented outside of JGroups.</p>
            </div>
            <div class="paragraph">
                <p>The feature set of jgroups-raft includes</p>
            </div>
            <div class="ulist">
                <ul>
                    <li>
                        <p>Leader election and append entries functionality by consensus</p>
                    </li>
                    <li>
                        <p>Persistent log (using FileBasedLog)</p>
                    </li>
                    <li>
                        <p>Dynamic addition and removal of cluster nodes</p>
                    </li>
                    <li>
                        <p>Cluster wide atomic counters</p>
                    </li>
                    <li>
                        <p>Replicated hash maps (replicated state machines)</p>
                    </li>
                </ul>
            </div>
            <div class="sect2">
                <h3 id="_architecture"><a class="anchor" href="#_architecture"></a>1.1. Architecture</h3>
                <div class="paragraph">
                    <p>The architecture of jgroups-raft is shown below.</p>
                </div>
                <div id="ArchitectureFig" class="imageblock">
                    <div class="content">
                        <img src="diag-ditaa-md5-5af6f3d74810311a62fbf32714c43099.svg" alt="Diagram" width="420" height="504">
                    </div>
                    <div class="title">Figure 1. The architecture of jgroups-raft.</div>
                </div>
                <div class="paragraph">
                    <p>The components that make up jgroups-raft are</p>
                </div>
                <div class="ulist">
                    <ul>
                        <li>
                            <p>A JGroups protocol stack with jgroups-raft specific protocols added:</p>
                            <div class="ulist">
                                <ul>
                                    <li>
                                        <p><code>NO_DUPES</code>: makes sure that a jgroups-raft node does not appear in a view more than once</p>
                                    </li>
                                    <li>
                                        <p><code>ELECTION</code>: handles leader election</p>
                                    </li>
                                    <li>
                                        <p><code>RAFT</code>: implements the Raft algorithm, i.e. appending entries to the persistent log, committing them, syncing new members etc</p>
                                    </li>
                                    <li>
                                        <p><code>REDIRECT</code>: redirects requests to the leader</p>
                                    </li>
                                    <li>
                                        <p><code>CLIENT</code>: accepts client requests over a socket, executes them and sends the results back to the clients</p>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li>
                            <p><code>Channel</code>: this is a regular JGroups <code>JChannel</code> or <code>ForkChannel</code></p>
                        </li>
                        <li>
                            <p><code>RaftHandle</code>: the main class for users of jgroups-raft to interact with</p>
                        </li>
                        <li>
                            <p><code>StateMachine</code>: an implementation of <code>StateMachine</code>. This is typically a replicated state machine. jgroups-raft
                                ships with a number of building blocks implementing <code>StateMachine</code> such as <code>CounterService</code> or <code>ReplicatedStateMachine</code>.</p>
                        </li>
                    </ul>
                </div>
                <div class="paragraph">
                    <p>The figure above shows one node in a cluster, but the other nodes have the same setup except that every node is required
                        to have a different <code>raft_id</code> (defined in <code>RAFT</code>). This is a string which defines one cluster member; all members
                        need to have different raft_ids (more on this later).</p>
                </div>
            </div>
        </div>
    </div>
    <div class="sect1">
        <h2 id="_using_jgroups_raft"><a class="anchor" href="#_using_jgroups_raft"></a>2. Using jgroups-raft</h2>
        <div class="sectionbody">
            <div class="paragraph">
                <p>Since jgroups-raft build on JGroups, we follow similar <a href="http://www.jgroups.org/manual5/index.html#Requirements">requirements</a>.
                    Currently, jgroups-raft requires JDK 11. jgroups-raft can be included in the POM:</p>
            </div>
            <div class="listingblock">
                <div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.jgroups<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jgroups-raft<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>X.Y.Z.Final<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
                </div>
            </div>
            <div class="paragraph">
                <p>Where <code>X</code>=major, <code>Y</code>=minor, and <code>Z</code>=patch.
                    The tags are available on <a href="https://github.com/jgroups-extras/jgroups-raft/tags">GitHub releases</a>.</p>
            </div>
            <div class="sect2">
                <h3 id="_cluster_members_and_identity"><a class="anchor" href="#_cluster_members_and_identity"></a>2.1. Cluster members and identity</h3>
                <div class="paragraph">
                    <p>Each cluster member has an address (a UUID) assigned by JGroups and a <code>raft_id</code> which needs to be assigned by the user.
                        The latter is a string (e.g. "A") which needs to be unique in the entire cluster. In other words, the <code>raft_id</code> is the
                        <em>identity</em> of a member for the sake of jgroups-raft.</p>
                </div>
                <div class="paragraph">
                    <p>A Raft cluster has a fixed size, so that a majority can be computed for leader election and appending of entries. The
                        members allowed into the cluster is defined in <code>RAFT.members</code>, e.g.</p>
                </div>
                <div class="listingblock">
                    <div class="content">
                        <pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;raft.RAFT</span> <span class="na">members=</span><span class="s">"A,B,C"</span> <span class="na">raft_id=</span><span class="s">"${raft_id:undefined}"</span><span class="nt">/&gt;</span></code></pre>
                    </div>
                </div>
                <div class="paragraph">
                    <p>This defines a cluster of 3 members: "A", "B" and "C" (whose majority is 2).</p>
                </div>
                <div class="paragraph">
                    <p>These are the <code>raft_id</code> attributes of the 3 members, so attribute <code>raft_id</code> in the example above needs to be one of them.
                        If we don&#8217;t start this member with the system property <code>-Draft_id=X</code> (where X needs to be "A", "B", or "C"),
                        then the member will start up as "undefined" is not a member of <code>{"A", "B", "C"}</code>.</p>
                </div>
                <div class="admonitionblock note">
                    <table>
                        <tr>
                            <td class="icon">
                                <i class="fa icon-note" title="Note"></i>
                            </td>
                            <td class="content">
                                Note that while <code>RAFT</code> ensures that non-members cannot join a cluster, the <code>NO_DUPES</code> protocol makes sure that
                                no duplicate member can join. Example: if we have <code>RAFT.members="A,B,C"</code> and actual members "A" and "B" joined, then
                                a join attempt by a member with duplicate name "B" will be rejected and that member won&#8217;t be able to join.
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="paragraph">
                    <p>Attribute <code>raft_id</code> is also used to define the location of the persistent log; unless <code>log_name</code> is defined in
                        <code>RAFT</code>, the location is computed as <code>&lt;temp_dir&gt;/&lt;raft_id&gt;.log</code>, e.g. <code>/tmp/A.log</code>.</p>
                </div>
                <div class="paragraph">
                    <p>Note that members can be added and removed dynamically (without taking the entire cluster down, changing the configuration
                        and restarting it), see <a href="#DynamicMembership">Adding and removing members dynamically</a>.</p>
                </div>
            </div>
            <div class="sect2">
                <h3 id="_rafthandle"><a class="anchor" href="#_rafthandle"></a>2.2. RaftHandle</h3>
                <div class="paragraph">
                    <p>As shown in <a href="#ArchitectureFig">The architecture of jgroups-raft.</a>, <code>RaftHandle</code> is the main class users will be dealing with. It provides methods to change
                        state (append entries) in the replicated state machines, and a state machine can be registered with it. The state machine
                        will be initialized at startup and updated by jgroups-raft whenever there is a change.</p>
                </div>
                <div class="paragraph">
                    <p>A successful change is committed to the persistent logs of all cluster members and applied to their state machines, so
                        all state machines have exactly the same state.</p>
                </div>
                <div class="sect3">
                    <h4 id="_creation"><a class="anchor" href="#_creation"></a>2.2.1. Creation</h4>
                    <div class="paragraph">
                        <p>An instance of RaftHandle is associated with exactly <em>one</em> JGroups channel, and can be created as follows:</p>
                    </div>
                    <div class="listingblock">
                        <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">JChannel</span> <span class="n">ch</span><span class="o">=</span><span class="k">new</span> <span class="nc">JChannel</span><span class="o">(</span><span class="s">"/home/bela/raft.xml"</span><span class="o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nc">RaftHandle</span> <span class="n">handle</span><span class="o">=</span><span class="k">new</span> <span class="nc">RaftHandle</span><span class="o">(</span><span class="n">ch</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>      <i class="conum" data-value="2"></i><b>(2)</b>
<span class="n">ch</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"raft-cluster"</span><span class="o">);</span>                      <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
                        </div>
                    </div>
                    <div class="colist arabic">
                        <table>
                            <tr>
                                <td><i class="conum" data-value="1"></i><b>1</b></td>
                                <td>A new JGroups channel is created (see the JGroups manual for details on the JGroups API)</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="2"></i><b>2</b></td>
                                <td>A RaftHandle instance is created over the channel (which must be non-null). The second argument is an implementation
                                    of <code>StateMachine</code>. If null, no changes will be applied. The state machine can be set with <code>stateMachine(StateMachine sm)</code>.</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="3"></i><b>3</b></td>
                                <td>The channel is connected which causes the member to join the cluster</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="sect3">
                    <h4 id="_making_changes"><a class="anchor" href="#_making_changes"></a>2.2.2. Making changes</h4>
                    <div class="paragraph">
                        <p>The <code>setX()</code> methods can be used to make changes:</p>
                    </div>
                    <div class="listingblock">
                        <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">byte</span><span class="o">[]</span> <span class="nf">set</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kt">byte</span><span class="o">[]</span> <span class="nf">set</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="nf">setAsync</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">);</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
                        </div>
                    </div>
                    <div class="colist arabic">
                        <table>
                            <tr>
                                <td><i class="conum" data-value="1"></i><b>1</b></td>
                                <td>Synchronous change; the caller will be blocked until the change has been forwarded to the leader, which sends it to
                                    all cluster members which apply it to their persistent logs and ack the change back to the leader. Once the leader
                                    gets a majority of acks, it commits the change to its own log, applies it to its state machine and returns the
                                    response to the caller. The state machines thus only contain <em>committed changes</em>.</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="2"></i><b>2</b></td>
                                <td>Same as above, except that this call is bounded with a timeout. If it elapses before a majority of acks have been
                                    received, a <code>TimeoutException</code> will be thrown.</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="3"></i><b>3</b></td>
                                <td>Asynchronous change; this method returns immediately with a <code>CompletableFuture</code> which can be used to retrieve the
                                    result later, or to provide some code that&#8217;s executed as soon as the result is available (e.g. <code>whenComplete()</code>).</td>
                            </tr>
                        </table>
                    </div>
                    <div class="paragraph">
                        <p>The contents of the request and response buffers is application specific.</p>
                    </div>
                    <div class="paragraph">
                        <p>For example, if we implemented a replicated hash map, then a request could be a <code>put(key,value)</code>. The <code>put()</code>
                            would have to be serialized into the buffer, as well as the key and the value.</p>
                    </div>
                    <div class="paragraph">
                        <p>When committing the change, every state machine needs to de-serialize the buffer into a <code>put(key,value)</code> and apply it to
                            its state (see <a href="#ImplementingStateMachine">Implementing a StateMachine</a>). If there is a return value to the <code>put()</code> call, e.g. the previous value
                            associated with <code>key</code>, then it will be serialized into a buffer and returned as result of one of the <code>setX()</code> calls.</p>
                    </div>
                </div>
                <div class="sect3">
                    <h4 id="_reading_values"><a class="anchor" href="#_reading_values"></a>2.2.3. Reading values</h4>
                    <div class="paragraph">
                        <p>The <code>getX()</code> methods can be used to read the current state:</p>
                    </div>
                    <div class="listingblock">
                        <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">byte</span><span class="o">[]</span> <span class="nf">get</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kt">byte</span><span class="o">[]</span> <span class="nf">get</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="nf">getAsync</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">);</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
                        </div>
                    </div>
                    <div class="colist arabic">
                        <table>
                            <tr>
                                <td><i class="conum" data-value="1"></i><b>1</b></td>
                                <td>A synchronous call to read a value. The caller blocks until the operation is complete.</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="2"></i><b>2</b></td>
                                <td>Same as above, except this call has a defined timeout.</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="3"></i><b>3</b></td>
                                <td>An asynchronous version that returns a <code>CompletableFuture</code> and does not block the caller.</td>
                            </tr>
                        </table>
                    </div>
                    <div class="paragraph">
                        <p>To provide high performance for read-heavy workloads, JGroups Raft implements the read-only optimization described in the Raft dissertation (Section 6.4).
                            This allows the leader to serve read requests without writing to the Raft log, which increases the throughput and don&#8217;t grow the persistent log, which also helps during restarts.</p>
                    </div>
                    <div class="paragraph">
                        <p>The process works as follows: when the leader receives a read request, it first confirms with a quorum of followers that it is still the leader.
                            Once its leadership is verified, it serves the read request based on its current committed state.
                            The leader can batch several read operations and sever them together after each confirmation.
                            This leadership check ensures data consistency while avoiding the cost of a full consensus round for every read.</p>
                    </div>
                    <div class="admonitionblock warning">
                        <table>
                            <tr>
                                <td class="icon">
                                    <i class="fa icon-warning" title="Warning"></i>
                                </td>
                                <td class="content">
                                    Do <strong>not</strong> update the state machine using the <code>getX</code> methods. This could leave the state machine in an undefined state.
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="sect3">
                    <h4 id="ImplementingStateMachine"><a class="anchor" href="#ImplementingStateMachine"></a>2.2.4. Implementing a StateMachine</h4>
                    <div class="paragraph">
                        <p><code>StateMachine</code> is an interface and is defined as follows:</p>
                    </div>
                    <div class="listingblock">
                        <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StateMachine</span> <span class="o">{</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="nf">apply</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="kt">void</span>   <span class="nf">readContentFrom</span><span class="o">(</span><span class="nc">DataInput</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>               <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="kt">void</span>   <span class="nf">writeContentTo</span><span class="o">(</span><span class="nc">DataOutput</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>              <i class="conum" data-value="3"></i><b>(3)</b>
<span class="o">}</span></code></pre>
                        </div>
                    </div>
                    <div class="colist arabic">
                        <table>
                            <tr>
                                <td><i class="conum" data-value="1"></i><b>1</b></td>
                                <td>This method is called whenever a log entry is <em>committed</em>. The buffer&#8217;s contents are application specific (e.g this
                                    could be a serialized <code>put(key,value)</code> as discussed above. If there is a return value of applying the change to the
                                    state machine, it needs to be serialized so that it can be returned to the caller (e.g. a client).</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="2"></i><b>2</b></td>
                                <td>This method is called when <code>RAFT</code> needs to initialize a state machine from a <em>snapshot</em> (a dump of a state
                                    machine&#8217;s contents to an external stream (e.g. a file)). The <code>writeContentTo()</code> method below wrote the contents
                                    to a file before, in an application specific format, and this method now needs to read the contents back into the
                                    state machine.</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="3"></i><b>3</b></td>
                                <td>This method is the opposite of <code>readContentFrom()</code> and writes the contents of this state machine to a stream
                                    (e.g. a file).</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="sect3">
                    <h4 id="Snapshots"><a class="anchor" href="#Snapshots"></a>2.2.5. Snapshotting and state transfer</h4>
                    <div class="paragraph">
                        <p>All cluster members maintain a persistent log and append all changes as log entries to the end of the log. To prevent
                            logs from growing indefinitely, a <em>snapshot</em> of the state machine can be made and the log truncated. This is done
                            (programmatically) with method <code>snapshot()</code>, or declaratively (see below).</p>
                    </div>
                    <div class="paragraph">
                        <p>This method calls <code>StateMachine.writeContentTo()</code> to dump the state of the state machine into a snapshot file and then
                            truncates the log. New members who don&#8217;t have a log yet are initialized by sending them the snapshot first. After that,
                            they will catch up via the regular Raft mechanism.</p>
                    </div>
                    <div class="paragraph">
                        <p>Logs can be snapshot automatically by setting <code>RAFT.max_log_size</code> to the max number of bytes that a log is allowed to
                            grow to until a snapshot is taken.</p>
                    </div>
                </div>
                <div class="sect3">
                    <h4 id="_miscellaneous_methods"><a class="anchor" href="#_miscellaneous_methods"></a>2.2.6. Miscellaneous methods</h4>
                    <div class="paragraph">
                        <p>Other methods in <code>RaftHandle</code> include:</p>
                    </div>
                    <div class="dlist">
                        <dl>
                            <dt class="hdlist1">addServer(String server)</dt>
                            <dd>
                                <p>Asynchronously adds a new member to the cluster with id <code>server</code> and returns a
                                    <code>CompletableFuture&lt;byte[]&gt;</code>. See more about membership change in <a href="#DynamicMembership">Adding and removing members dynamically</a>.</p>
                            </dd>
                            <dt class="hdlist1">removeServer(String server)</dt>
                            <dd>
                                <p>Asynchronously removes a member from the cluster with id <code>server</code> and returns a
                                    <code>CompletableFuture&lt;byte[]&gt;</code>. See more about membership change in <a href="#DynamicMembership">Adding and removing members dynamically</a>.</p>
                            </dd>
                            <dt class="hdlist1">leader()</dt>
                            <dd>
                                <p>Returns the address of the current Raft leader, or null if there is no leader (e.g. in case there was no
                                    majority to elect a leader)</p>
                            </dd>
                            <dt class="hdlist1">isLeader()</dt>
                            <dd>
                                <p>Whether or not the current member is the leader</p>
                            </dd>
                            <dt class="hdlist1">addRoleListener(RAFT.RoleChange listener)</dt>
                            <dd>
                                <p>Allows to register a  <code>RoleChange</code> listener which is notified when the current
                                    member changes its role (<code>Leader</code>, <code>Follower</code>, <code>Candidate</code>)</p>
                            </dd>
                            <dt class="hdlist1">currentTerm()</dt>
                            <dd>
                                <p>Returns the current term (see Raft for details)</p>
                            </dd>
                            <dt class="hdlist1">lastApplied()</dt>
                            <dd>
                                <p>Returns the index of the last log entry that was appended to the log</p>
                            </dd>
                            <dt class="hdlist1">commitIndex()</dt>
                            <dd>
                                <p>Returns the index of the last log entry that was committed</p>
                            </dd>
                            <dt class="hdlist1">raft()</dt>
                            <dd>
                                <p>Returns a reference to the <code>RAFT</code> protocol in the current member&#8217;s stack. Provided for experts who need to
                                    access <code>RAFT</code> directly.</p>
                            </dd>
                            <dt class="hdlist1">raftId(String id)</dt>
                            <dd>
                                <p>Used to set the <code>raft_id</code> programmatically (note that this can also be done by setting <code>raft_id</code> in
                                    <code>RAFT</code> in the XML configuration. For example, the following code sets <code>raft_id</code> from the command line:</p>
                            </dd>
                        </dl>
                    </div>
                    <div class="listingblock">
                        <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="nc">String</span> <span class="n">raft_id</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">JChannel</span> <span class="n">ch</span><span class="o">=</span><span class="k">new</span> <span class="nc">JChannel</span><span class="o">(</span><span class="s">"raft.xml"</span><span class="o">).</span><span class="na">name</span><span class="o">(</span><span class="n">raft_id</span><span class="o">);</span>   <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nc">RaftHandle</span> <span class="n">handle</span><span class="o">=</span><span class="k">new</span> <span class="nc">RaftHandle</span><span class="o">(</span><span class="n">ch</span><span class="o">,</span> <span class="k">this</span><span class="o">).</span><span class="na">raftId</span><span class="o">(</span><span class="n">raft_id</span><span class="o">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="n">ch</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"raft-cluster"</span><span class="o">);</span>  <i class="conum" data-value="4"></i><b>(4)</b>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nf">bla</span><span class="o">().</span><span class="na">start</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="o">}</span></code></pre>
                        </div>
                    </div>
                    <div class="colist arabic">
                        <table>
                            <tr>
                                <td><i class="conum" data-value="1"></i><b>1</b></td>
                                <td>The <code>raft_id</code> can for example be passed to the program as an argument</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="2"></i><b>2</b></td>
                                <td>The channel is created and its logical name set to be the same as <code>raft_id</code>. This is not necessary, but convenient.</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="3"></i><b>3</b></td>
                                <td>Now <code>raft_id</code> can be set via <code>RaftHandle.raftId(String id)</code>.</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="sect2">
                <h3 id="_configuration"><a class="anchor" href="#_configuration"></a>2.3. Configuration</h3>
                <div class="paragraph">
                    <p>The configuration of a member is either done declaratively via an XML config file or programmatically. Refer to the
                        JGroups documentation for details.</p>
                </div>
                <div class="paragraph">
                    <p>A sample XML configuration file is shown below (edited for brevity):</p>
                </div>
                <div class="listingblock">
                    <div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;config</span> <span class="na">xmlns=</span><span class="s">"urn:org:jgroups"</span>
        <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="na">xsi:schemaLocation=</span><span class="s">"urn:org:jgroups http://www.jgroups.org/schema/jgroups.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;UDP</span>
         <span class="na">mcast_addr=</span><span class="s">"228.5.5.5"</span>
         <span class="na">mcast_port=</span><span class="s">"${jgroups.udp.mcast_port:45588}"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;PING</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;MERGE3</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;FD_SOCK/&gt;</span>
    <span class="nt">&lt;FD_ALL/&gt;</span>
    <span class="nt">&lt;VERIFY_SUSPECT</span> <span class="na">timeout=</span><span class="s">"1500"</span>  <span class="nt">/&gt;</span>
    <span class="nt">&lt;pbcast.NAKACK2</span> <span class="na">xmit_interval=</span><span class="s">"500"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;UNICAST3</span> <span class="na">xmit_interval=</span><span class="s">"500"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;pbcast.STABLE</span> <span class="na">desired_avg_gossip=</span><span class="s">"50000"</span>
                   <span class="na">max_bytes=</span><span class="s">"4M"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;raft.NO_DUPES/&gt;</span>                                                         <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="nt">&lt;pbcast.GMS</span> <span class="na">print_local_addr=</span><span class="s">"true"</span> <span class="na">join_timeout=</span><span class="s">"2000"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;UFC</span> <span class="na">max_credits=</span><span class="s">"2M"</span> <span class="na">min_threshold=</span><span class="s">"0.4"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;MFC</span> <span class="na">max_credits=</span><span class="s">"2M"</span> <span class="na">min_threshold=</span><span class="s">"0.4"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;FRAG2</span> <span class="na">frag_size=</span><span class="s">"60K"</span>  <span class="nt">/&gt;</span>
    <span class="nt">&lt;raft.ELECTION</span> <span class="na">election_min_interval=</span><span class="s">"100"</span> <span class="na">election_max_interval=</span><span class="s">"500"</span><span class="nt">/&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nt">&lt;raft.RAFT</span> <span class="na">members=</span><span class="s">"A,B,C,D"</span> <span class="na">raft_id=</span><span class="s">"${raft_id:undefined}"</span><span class="nt">/&gt;</span>            <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nt">&lt;raft.REDIRECT/&gt;</span>                                                         <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nt">&lt;raft.CLIENT</span> <span class="na">bind_addr=</span><span class="s">"0.0.0.0"</span> <span class="nt">/&gt;</span>                                      <i class="conum" data-value="5"></i><b>(5)</b>
<span class="nt">&lt;/config&gt;</span></code></pre>
                    </div>
                </div>
                <div class="colist arabic">
                    <table>
                        <tr>
                            <td><i class="conum" data-value="1"></i><b>1</b></td>
                            <td><code>NO_DUPES</code>: checks that joining a new member doesn&#8217;t lead to duplicate <code>raft_ids</code> in the membership. Rejects the
                                JOIN if it would. Must be placed somewhere <em>below</em> <code>GMS</code></td>
                        </tr>
                        <tr>
                            <td><i class="conum" data-value="2"></i><b>2</b></td>
                            <td><code>ELECTION</code>: this protocol implements leader election, as defined in Raft. It is independent from <code>RAFT</code> and could
                                (and may, in the future) be replaced with a different election protocol. Attributes <code>election_min_interval</code> and
                                <code>election_max_interval</code> define the range from which jgroups-raft picks a random election timeout.</td>
                        </tr>
                        <tr>
                            <td><i class="conum" data-value="3"></i><b>3</b></td>
                            <td><code>RAFT</code>: the main protocol implementing log appending and committing, handling state machine updates, snapshotting etc.
                                Attribute <code>members</code> defines the (fixed) membership (may still be redefined by <code>addServer</code>/<code>removeServer</code> log entries
                                when initializing a member from the persistent log). Attribute <code>raft_id</code> defines the ID of the current member (needs
                                to be an element of <code>members</code>, as discussed earlier).</td>
                        </tr>
                        <tr>
                            <td><i class="conum" data-value="4"></i><b>4</b></td>
                            <td><code>REDIRECT</code> is used to redirect requests to the current Raft leader, or to throw an exception if no member is leader</td>
                        </tr>
                        <tr>
                            <td><i class="conum" data-value="5"></i><b>5</b></td>
                            <td><code>CLIENT</code> listens on a socket (port <code>1965</code> by default) for client requests, executes them and sends the result back
                                to the clients. Currently, <code>addServer</code> and <code>removeServer</code> has been implemented.</td>
                        </tr>
                    </table>
                </div>
                <div class="paragraph">
                    <p>This is a regular JGroups XML configuration, except that jgroups-raft added a few additional protocols.</p>
                </div>
            </div>
            <div class="sect2">
                <h3 id="DynamicMembership"><a class="anchor" href="#DynamicMembership"></a>2.4. Adding and removing members dynamically</h3>
                <div class="paragraph">
                    <p>The <code>RAFT</code> protocol provides methods <code>addServer(String raft_id)</code> and <code>removeServer(String raft_id)</code> to add and remove
                        servers from the static membership (defined by <code>RAFT.members</code>). Only one server at a time can be added and removed, and
                        adding or removing a server needs a majority ack to be committed.</p>
                </div>
                <div class="paragraph">
                    <p>Both methods are exposed via JMX, so <code>jconsole</code> could be used. However, jgroups-raft also provides a script
                        (<code>client.sh</code>) to do this in a more convenient way. The script uses <code>Client</code> to connect to a member&#8217;s <code>CLIENT</code> protocol
                        running at <code>localhost:1965</code> (can be changed). The request is then forwarded to the current leader.</p>
                </div>
                <div class="paragraph">
                    <p>The steps to add a member are as follows (say we have <code>RAFT.members="A,B,C"</code> and want to add "D"):</p>
                </div>
                <div class="ulist">
                    <ul>
                        <li>
                            <p>Call <code>bin/client.sh -add D</code></p>
                            <div class="ulist">
                                <ul>
                                    <li>
                                        <p>If needed, <code>-port PORT</code> or <code>-bind_addr ADDR</code> can be given, e.g. if we need to reach a member running on a different host</p>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li>
                            <p>Once <code>A</code> (the leader) processed <code>addServer("D")</code>, everybody&#8217;s <code>RAFT.members</code> is <code>"A","B","C","D"</code></p>
                        </li>
                        <li>
                            <p>At this point, the XML configuration files should be updated so that <code>RAFT.members="A,B,C,D"</code></p>
                        </li>
                        <li>
                            <p>If not, members will read the correct membership when getting initialized by their logs</p>
                        </li>
                        <li>
                            <p>A new member <code>D</code> can now be started (its XML config needs to have the correct <code>members</code> attribute !)</p>
                        </li>
                    </ul>
                </div>
                <div class="paragraph">
                    <p>Notice that membership changes survive through restarts. If a node must be removed or added, an operation must be
                        submitted, only restarting does not affect membership.</p>
                </div>
                <div class="sect3">
                    <h4 id="_learner_nodes"><a class="anchor" href="#_learner_nodes"></a>2.4.1. Learner nodes</h4>
                    <div class="paragraph">
                        <p>JGroups Raft supports <strong>learner nodes</strong> to scale read-heavy applications.
                            Learners act as read-only replicas that mirror the leader&#8217;s log but don&#8217;t participate in the voting process.
                            Because they don&#8217;t affect the quorum, you can add as many as needed.
                            This is ideal for reducing latency by placing nodes closer to your users without altering the core cluster&#8217;s fault tolerance.</p>
                    </div>
                    <div class="paragraph">
                        <p>The primary role of a learner node is to facilitate safe and seamless cluster expansion.
                            When you add a new server directly to a Raft cluster, there&#8217;s a risk of temporary unavailability because the new server needs time to catch up with the leader&#8217;s log.
                            By adding the new server as a learner first, it can replicate the log without being a voting member.
                            Once it is fully synchronized with the leader, it can be promoted to a follower, gaining voting rights and becoming a full member of the cluster without any disruption.</p>
                    </div>
                    <div class="admonitionblock note">
                        <table>
                            <tr>
                                <td class="icon">
                                    <i class="fa icon-note" title="Note"></i>
                                </td>
                                <td class="content">
                                    You can learn (pun intended) more in the <a href="https://github.com/jgroups-extras/jgroups-raft/blob/bc1702d66d6d741105d97e34fe8902b1eb8c05c8/doc/design/LearnerNodes.adoc">design document</a>.
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="sect1">
        <h2 id="BuildingBlocks"><a class="anchor" href="#BuildingBlocks"></a>3. Building blocks</h2>
        <div class="sectionbody">
            <div class="paragraph">
                <p>Similar to JGroups' building blocks, jgroups-raft also has building blocks, which provide additional functionality on
                    top of a <code>RaftHandle</code>. They are typically given a JChannel, create a <code>RaftHandle</code> and register themselves as
                    <code>StateMachine</code> with the handle. Building blocks offer a different interface to the users, e.g. a replicated hashmap
                    with puts and gets, or a distributed counter or lock.</p>
            </div>
            <div class="sect2">
                <h3 id="ReplicatedStateMachine"><a class="anchor" href="#ReplicatedStateMachine"></a>3.1. ReplicatedStateMachine</h3>
                <div class="paragraph">
                    <p><code>ReplicatedStateMachine</code> is a key-value store replicating its contents to all cluster members. Contrary to the JGroups
                        equivalent (<code>ReplicatedHashMap</code>), changes are replicated by consensus and logged to a persistent log.</p>
                </div>
                <div class="paragraph">
                    <p>While the JGroups version is allowed to make progress during network partitions, and users need to merge possibly
                        diverging state from different partitions after a partition heals, <code>ReplicatedStateMachine</code> will allow progress only in
                        the <em>majority partition</em>, so no state merging needs to be done after a partition heals.</p>
                </div>
                <div class="paragraph">
                    <p>Not having to merge state is certainly simpler, but comes at the expense of availability: if <code>N/2+1</code> members leave or
                        split into different partitions, <code>ReplicatedStateMachine</code> will be unavailable (all requests will time out).</p>
                </div>
                <div class="paragraph">
                    <p>However, the advantage is that the members' states will never diverge.</p>
                </div>
                <div class="paragraph">
                    <p><code>ReplicatedStateMachine</code> requires a <code>JChannel</code> in its constructor and has <code>put()</code>, <code>get()</code> and <code>remove()</code> methods.
                        The code below shows how to create an instance of <code>ReplicatedStateMachine</code> and add an element to it:</p>
                </div>
                <div class="listingblock">
                    <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="nc">String</span> <span class="n">raft_id</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">JChannel</span> <span class="n">ch</span><span class="o">=</span><span class="k">new</span> <span class="nc">JChannel</span><span class="o">(</span><span class="s">"raft.xml"</span><span class="o">).</span><span class="na">name</span><span class="o">(</span><span class="n">raft_id</span><span class="o">);</span>
    <span class="nc">ReplicatedStateMachine</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">rsm</span><span class="o">=</span><span class="k">new</span> <span class="nc">ReplicatedStateMachine</span><span class="o">&lt;&gt;(</span><span class="n">ch</span><span class="o">)</span>
        <span class="o">.</span><span class="na">raftId</span><span class="o">(</span><span class="n">raft_id</span><span class="o">);</span>
    <span class="n">ch</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"rsm-cluster"</span><span class="o">);</span>
    <span class="n">rsm</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"Bela"</span><span class="o">);</span>
<span class="o">}</span></code></pre>
                    </div>
                </div>
                <div class="paragraph">
                    <p>There&#8217;s a demo <code>ReplicatedStateMachineDemo</code> which can be used to interactively use <code>ReplicatedStateMachine</code>.</p>
                </div>
                <div class="sect3">
                    <h4 id="_reads_and_consensus"><a class="anchor" href="#_reads_and_consensus"></a>3.1.1. Reads and consensus</h4>
                    <div class="paragraph">
                        <p><code>ReplicatedStateMachine</code> has a configurable behavior for reads, using quorum reads by default. This means that all read
                            requests are sent through <code>RAFT</code> and require a majority to complete. This provides a linearizable read, but, on the other
                            hand, it takes longer to complete.</p>
                    </div>
                    <div class="paragraph">
                        <p>If an application does not require linearizable reads, it can change the behavior and only read the value locally,
                            possibly stale, but having a faster response since the request does not go through <code>RAFT</code>.</p>
                    </div>
                    <div class="paragraph">
                        <p>The behavior is changed by calling <code>ReplicatedStateMachine.allowDirtyReads(boolean)</code>.</p>
                    </div>
                </div>
            </div>
            <div class="sect2">
                <h3 id="CounterService"><a class="anchor" href="#CounterService"></a>3.2. CounterService</h3>
                <div class="paragraph">
                    <p><code>CounterService</code> provides a replicated counter which can be used in a synchronous (<code>SyncCounter</code>) and asynchronous
                        (<code>AsyncCounter</code>) mode. The base interface is <code>Counter</code>:</p>
                </div>
                <div class="listingblock">
                    <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Counter</span> <span class="o">{</span>
    <span class="nc">String</span>                <span class="nf">getName</span><span class="o">();</span>
    <span class="nc">SyncCounter</span>           <span class="nf">sync</span><span class="o">();</span>
    <span class="nc">AsyncCounter</span>          <span class="nf">async</span><span class="o">();</span>
    <span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">Counter</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">withOptions</span><span class="o">(</span><span class="nc">Options</span> <span class="n">opts</span><span class="o">);</span>
<span class="o">}</span></code></pre>
                    </div>
                </div>
                <div class="paragraph">
                    <p>The <code>sync()</code> and <code>async()</code> methods can be used to switch between the modes. The <code>withOptions()</code> method can be used to
                        make a counter ignore return values (see below).</p>
                </div>
                <div class="sect3">
                    <h4 id="_synchronous_counters"><a class="anchor" href="#_synchronous_counters"></a>3.2.1. Synchronous counters</h4>
                    <div class="paragraph">
                        <p>Synchronous counters block until an operation has completed, and return a value. The interface <code>SyncCounter</code> is:</p>
                    </div>
                    <div class="listingblock">
                        <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SyncCounter</span> <span class="kd">extends</span> <span class="nc">Counter</span> <span class="o">{</span>
    <span class="kt">long</span>            <span class="nf">get</span><span class="o">();</span>
    <span class="kt">long</span>            <span class="nf">getLocal</span><span class="o">();</span>
    <span class="kt">void</span>            <span class="nf">set</span><span class="o">(</span><span class="kt">long</span> <span class="n">new_value</span><span class="o">);</span>
    <span class="k">default</span> <span class="kt">boolean</span> <span class="nf">compareAndSet</span><span class="o">(</span><span class="kt">long</span> <span class="n">exp</span><span class="o">,</span> <span class="kt">long</span> <span class="n">upd</span><span class="o">)</span> <span class="o">{</span><span class="k">return</span> <span class="n">compareAndSwap</span><span class="o">(</span><span class="n">exp</span><span class="o">,</span> <span class="n">upd</span><span class="o">)</span> <span class="o">==</span> <span class="n">exp</span><span class="o">;}</span>
    <span class="kt">long</span>            <span class="nf">compareAndSwap</span><span class="o">(</span><span class="kt">long</span> <span class="n">expect</span><span class="o">,</span> <span class="kt">long</span> <span class="n">update</span><span class="o">);</span>
    <span class="k">default</span> <span class="kt">long</span>    <span class="nf">incrementAndGet</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="n">addAndGet</span><span class="o">(</span><span class="mi">1L</span><span class="o">);}</span>
    <span class="k">default</span> <span class="kt">long</span>    <span class="nf">decrementAndGet</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="n">addAndGet</span><span class="o">(-</span><span class="mi">1L</span><span class="o">);}</span>
    <span class="kt">long</span>            <span class="nf">addAndGet</span><span class="o">(</span><span class="kt">long</span> <span class="n">delta</span><span class="o">);</span>
<span class="o">}</span></code></pre>
                        </div>
                    </div>
                    <div class="paragraph">
                        <p>The methods are:</p>
                    </div>
                    <table class="tableblock frame-all grid-all fit-content">
                        <colgroup>
                            <col>
                            <col>
                        </colgroup>
                        <thead>
                        <tr>
                            <th class="tableblock halign-left valign-top">Name</th>
                            <th class="tableblock halign-left valign-top">Description</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="tableblock halign-left valign-top"><p class="tableblock"><code>get</code></p></td>
                            <td class="tableblock halign-left valign-top"><p class="tableblock">Returns the value of the counter. If the CounterService allows for dirty reads (see below), <code>getLocal()</code> is
                                called. Otherwise, a remote get request is sent to the leader.</p></td>
                        </tr>
                        <tr>
                            <td class="tableblock halign-left valign-top"><p class="tableblock"><code>getLocal</code></p></td>
                            <td class="tableblock halign-left valign-top"><p class="tableblock">Returns the value of the counter. This call is purely local and may return a stale value.</p></td>
                        </tr>
                        <tr>
                            <td class="tableblock halign-left valign-top"><p class="tableblock"><code>set</code></p></td>
                            <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the value of the counter</p></td>
                        </tr>
                        <tr>
                            <td class="tableblock halign-left valign-top"><p class="tableblock"><code>compareAndSet</code></p></td>
                            <td class="tableblock halign-left valign-top"><p class="tableblock">Atomically updates the counter using a CAS operation</p></td>
                        </tr>
                        <tr>
                            <td class="tableblock halign-left valign-top"><p class="tableblock"><code>compareAndSwap</code></p></td>
                            <td class="tableblock halign-left valign-top"><p class="tableblock">Atomically updates the counter using a compare-and-swap operation</p></td>
                        </tr>
                        <tr>
                            <td class="tableblock halign-left valign-top"><p class="tableblock"><code>incrementAndGet</code></p></td>
                            <td class="tableblock halign-left valign-top"><p class="tableblock">Atomically increments the counter and returns the new value</p></td>
                        </tr>
                        <tr>
                            <td class="tableblock halign-left valign-top"><p class="tableblock"><code>decrementAndGet</code></p></td>
                            <td class="tableblock halign-left valign-top"><p class="tableblock">Atomically decrements the counter and returns the new value</p></td>
                        </tr>
                        <tr>
                            <td class="tableblock halign-left valign-top"><p class="tableblock"><code>addAndGet</code></p></td>
                            <td class="tableblock halign-left valign-top"><p class="tableblock">Atomically adds the given value to the current value</p></td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="paragraph">
                        <p>The synchronous methods block until consensus has been reached. This means that a method (e.g. <code>addAndGet()</code>) may block
                            indefinitely, e.g. when less than a majority of members have ack&#8217;ed the change.</p>
                    </div>
                </div>
                <div class="sect3">
                    <h4 id="_asynchronous_counters"><a class="anchor" href="#_asynchronous_counters"></a>3.2.2. Asynchronous counters</h4>
                    <div class="paragraph">
                        <p>Asynchronous counters are defined in <code>AsyncCounter</code>:</p>
                    </div>
                    <div class="listingblock">
                        <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AsyncCounter</span> <span class="kd">extends</span> <span class="nc">Counter</span> <span class="o">{</span>
    <span class="k">default</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span>    <span class="nf">get</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="n">addAndGet</span><span class="o">(</span><span class="mi">0</span><span class="o">);}</span>
    <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span>            <span class="nf">getLocal</span><span class="o">();</span>
    <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span>            <span class="nf">set</span><span class="o">(</span><span class="kt">long</span> <span class="n">new_value</span><span class="o">);</span>

    <span class="k">default</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="nf">compareAndSet</span><span class="o">(</span><span class="kt">long</span> <span class="n">expect</span><span class="o">,</span> <span class="kt">long</span> <span class="n">update</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">compareAndSwap</span><span class="o">(</span><span class="n">expect</span><span class="o">,</span> <span class="n">update</span><span class="o">).</span><span class="na">thenApply</span><span class="o">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="n">value</span> <span class="o">==</span> <span class="n">expect</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span>            <span class="nf">compareAndSwap</span><span class="o">(</span><span class="kt">long</span> <span class="n">expect</span><span class="o">,</span> <span class="kt">long</span> <span class="n">update</span><span class="o">);</span>
    <span class="k">default</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="nf">incrementAndGet</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">addAndGet</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">default</span> <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span>    <span class="nf">decrementAndGet</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">addAndGet</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">CompletionStage</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span>            <span class="nf">addAndGet</span><span class="o">(</span><span class="kt">long</span> <span class="n">delta</span><span class="o">);</span>
<span class="o">}</span></code></pre>
                        </div>
                    </div>
                    <div class="paragraph">
                        <p>The semantics of the methods correspond to their synchronous counterparts, but they return a <code>CompletionStage</code> instead
                            of the value. An example is shown below:</p>
                    </div>
                    <div class="listingblock">
                        <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCompareAndSwapChained</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">AsyncCounter</span> <span class="n">counter</span><span class="o">=</span><span class="n">counter_service</span><span class="o">.</span><span class="na">getOrCreateCounte</span><span class="o">(</span><span class="s">"ctr"</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">async</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">initialValue</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">finalValue</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

    <span class="n">counter</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">initialValue</span><span class="o">).</span><span class="na">toCompletableFuture</span><span class="o">().</span><span class="na">join</span><span class="o">();</span>

    <span class="nc">AtomicLong</span> <span class="n">rv</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicLong</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">compareAndSwap</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">finalValue</span><span class="o">)</span>
            <span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span><span class="n">rValue</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">rv</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">rValue</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">counters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">compareAndSwap</span><span class="o">(</span><span class="n">rValue</span><span class="o">,</span> <span class="n">finalValue</span><span class="o">);</span>
            <span class="o">})</span>
            <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="n">value</span> <span class="o">==</span> <span class="n">initialValue</span><span class="o">)</span>
            <span class="o">.</span><span class="na">toCompletableFuture</span><span class="o">()</span>
            <span class="o">.</span><span class="na">join</span><span class="o">();</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">;</span>
    <span class="k">assert</span> <span class="n">initialValue</span> <span class="o">==</span> <span class="n">rv</span><span class="o">.</span><span class="na">longValue</span><span class="o">();</span>
<span class="o">}</span></code></pre>
                        </div>
                    </div>
                    <div class="paragraph">
                        <p>A <code>Counter</code> implementation is created via the <code>CounterService</code> building block:</p>
                    </div>
                    <div class="listingblock">
                        <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CounterService</span> <span class="kd">implements</span> <span class="nc">StateMachine</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">CounterService</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">long</span>           <span class="nf">replTimeout</span><span class="o">();</span>
    <span class="kd">public</span> <span class="nc">CounterService</span> <span class="nf">replTimeout</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">boolean</span>        <span class="nf">allowDirtyReads</span><span class="o">();</span>
    <span class="kd">public</span> <span class="nc">CounterService</span> <span class="nf">allowDirtyReads</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">flag</span><span class="o">);</span>
    <span class="kd">public</span> <span class="nc">CounterService</span> <span class="nf">raftId</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">);</span>

    <span class="cm">/**
     * Returns an existing counter, or creates a new one if none exists
     * @param name Name of the counter, different counters have to have different names
     * @param initial_value The initial value of a new counter if there is no existing counter.
     * Ignored if the counter already exists
     * @return The counter implementation
     */</span>
    <span class="kd">public</span> <span class="nc">Counter</span> <span class="nf">getOrCreateCounter</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">long</span> <span class="n">initial_value</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>


    <span class="cm">/**
     * Deletes a counter instance (on the coordinator)
     * @param name The name of the counter. No-op if the counter doesn't exist
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteCounter</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>
<span class="o">}</span></code></pre>
                        </div>
                    </div>
                    <div class="paragraph">
                        <p><code>CounterService</code> is mainly used to get an existing or create a new <code>Counter</code> implementation (<code>getOrCreateCounter()</code>), or
                            to delete an existing counter (<code>deleteCounter()</code>).</p>
                    </div>
                    <div class="paragraph">
                        <p>To create an instance of <code>CounterService</code>, a JChannel has to be passed to the constructor. The sample code below
                            shows how to use this:</p>
                    </div>
                    <div class="listingblock">
                        <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="nc">String</span> <span class="n">raft_id</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">JChannel</span> <span class="n">ch</span><span class="o">=</span><span class="k">new</span> <span class="nc">JChannel</span><span class="o">(</span><span class="s">"raft.xml"</span><span class="o">).</span><span class="na">name</span><span class="o">(</span><span class="n">raft_id</span><span class="o">);</span>
    <span class="nc">CounterService</span> <span class="n">cs</span><span class="o">=</span><span class="k">new</span> <span class="nc">CounterService</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>                   <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="n">ch</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"counter-cluster"</span><span class="o">);</span>
    <span class="nc">SyncCounter</span> <span class="n">counter</span><span class="o">=</span><span class="n">cs</span><span class="o">.</span><span class="na">getOrCreateCounter</span><span class="o">(</span><span class="s">"mycounter"</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="n">counter</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>                                  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="n">counter</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>                                <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="kt">long</span> <span class="n">current_value</span><span class="o">=</span><span class="n">counter</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>                           <i class="conum" data-value="5"></i><b>(5)</b>
<span class="o">}</span></code></pre>
                        </div>
                    </div>
                    <div class="colist arabic">
                        <table>
                            <tr>
                                <td><i class="conum" data-value="1"></i><b>1</b></td>
                                <td>First a <code>CounterService</code> is created and given a reference to a channel</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="2"></i><b>2</b></td>
                                <td>Once the member has joined the cluster, we create a counter named "mycounter" with an initial value of 1</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="3"></i><b>3</b></td>
                                <td>The counter is then incremented to 2</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="4"></i><b>4</b></td>
                                <td>Now a compare-and-set operation sets the counter to 5 if it was 2</td>
                            </tr>
                            <tr>
                                <td><i class="conum" data-value="5"></i><b>5</b></td>
                                <td>The last operation fetches the current value of "mycounter"</td>
                            </tr>
                        </table>
                    </div>
                    <div class="paragraph">
                        <p>Any member in the cluster can change the same counter and all operations are ordered by the Raft leader, which causes
                            the replicated counters to have exactly the same value in all members.</p>
                    </div>
                    <div class="paragraph">
                        <p>Comparing this to the JGroups equivalent, a jgroups-raft counter never diverges in different members, again at the
                            expense of availability. In the JGroups version, counters are always available, but may diverge, e.g. in a split brain
                            scenario, and have to be reconciled by the application after the split brain is resolved.</p>
                    </div>
                    <div class="paragraph">
                        <p>There&#8217;s a demo <code>CounterServiceDemo</code> which can be used to interactively manipulate replicated counters.</p>
                    </div>
                </div>
                <div class="sect3">
                    <h4 id="_reads_and_consensus_2"><a class="anchor" href="#_reads_and_consensus_2"></a>3.2.3. Reads and consensus</h4>
                    <div class="paragraph">
                        <p>Currently (as of jgroups-raft version 0.4), reading a counter is by default <em>dirty</em>, meaning that a read may return a
                            stale value.</p>
                    </div>
                    <div class="paragraph">
                        <p>This can be changed by calling <code>counter_service.allowDirtyReads(false)</code>.</p>
                    </div>
                </div>
                <div class="sect3">
                    <h4 id="_ignoring_return_values"><a class="anchor" href="#_ignoring_return_values"></a>3.2.4. Ignoring return values</h4>
                    <div class="paragraph">
                        <p>Sometimes, a caller is not interested in the result of an operation. E.g. a stress test may want to update a counter
                            many times, e.g. with many different threads, and only then fetch the final counter value. When this is the case,
                            an <em>option</em> can be used with a counter:</p>
                    </div>
                    <div class="listingblock">
                        <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIgnoreReturnValue</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">SyncCounter</span> <span class="n">counter</span><span class="o">=</span><span class="n">counter_service</span><span class="o">.</span><span class="na">getOrCreateCounter</span><span class="o">(</span><span class="s">"ctr"</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">ret</span><span class="o">=</span><span class="n">counter</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="n">counter</span><span class="o">=</span><span class="n">counter</span><span class="o">.</span><span class="na">withOptions</span><span class="o">(</span><span class="nc">Options</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="n">ret</span><span class="o">=</span><span class="n">counter</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="k">assert</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">ret</span><span class="o">=</span><span class="n">counter</span><span class="o">.</span><span class="na">getLocal</span><span class="o">();</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="o">}</span></code></pre>
                        </div>
                    </div>
                    <div class="paragraph">
                        <p>In (1), a counter is incremented and the new value returned. This returns <code>1</code></p>
                    </div>
                    <div class="paragraph">
                        <p>In (2) , a counter is created with an <code>Option</code>, which declares that return values are to be ignored. Consequently,
                            when we increment the counter in (3), the return value is <code>0</code>, although the counter was indeed incremented, as
                            shown when fetching the value in (4).</p>
                    </div>
                    <div class="paragraph">
                        <p>Returning <code>0</code> may not be the most clever use of options, but is the result of autoboxing a <code>null</code> <code>Long</code> value into
                            a <code>long</code>. The idea is that the result of an operation that has this option set, should not be assigned to a variable.</p>
                    </div>
                    <div class="paragraph">
                        <p>When the ignore-return-value option is set, <code>REDIRECT</code> doesn&#8217;t need to serialize and send the result from the leader
                            to the follower, and <code>RAFT</code> does not need to serialize the result into a <code>byte[]</code> array, either. The cost reduction
                            here may not be insignificant, depending on the (serialized) size of the result values and the frequency of operations.</p>
                    </div>
                </div>
            </div>
            <div class="sect2">
                <h3 id="_cluster_singleton_service"><a class="anchor" href="#_cluster_singleton_service"></a>3.3. Cluster singleton service</h3>
                <div class="paragraph">
                    <p>A <em>singleton service</em> is a service which is supposed to run only once in an entire cluster. Typically, in JGroups, a
                        singleton service is started on the first member of a cluster. For example, if we have <code>{A,B,C,D,E}</code>, the singleton
                        service (or services) would be running on <code>A</code>.</p>
                </div>
                <div class="paragraph">
                    <p>If we have a partition, such that the cluster falls apart into <code>{A,B,C}</code> and <code>{D,E}</code>, then an <em>additional</em> singleton
                        would be started on <code>D</code>, as <code>D</code> became coordinator and doesn&#8217;t know <code>{A,B,C}</code> didn&#8217;t leave, but were partitioned away
                        instead.</p>
                </div>
                <div class="paragraph">
                    <p>When the partition ends, if <code>D</code> is not coordinator anymore, it would stop its singleton services.</p>
                </div>
                <div class="paragraph">
                    <p>If multiple singletons (as provided by JGroups, e.g. during a network split) cannot be tolerated by the application,
                        and the application has a requirement that <em>at most one singleton service</em> can be running (better none than two),
                        jgroups-raft can be used.</p>
                </div>
                <div class="paragraph">
                    <p>The mechanism to implement singleton services in jgroups-raft is leader election: it is guaranteed that at most one
                        leader exists in a given cluster at the same time. This is exactly what we need for singletons. The code below shows
                        how to do this:</p>
                </div>
                <div class="listingblock">
                    <div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">JChannel</span> <span class="n">ch</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
<span class="nc">RaftHandle</span> <span class="n">handle</span><span class="o">=</span><span class="k">new</span> <span class="nc">RaftHandle</span><span class="o">(</span><span class="n">ch</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="n">handle</span><span class="o">.</span><span class="na">addRoleListener</span><span class="o">(</span><span class="n">role</span> <span class="o">-&gt;</span> <span class="o">{</span>            <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="k">if</span><span class="o">(</span><span class="n">role</span> <span class="o">==</span> <span class="nc">Role</span><span class="o">.</span><span class="na">Leader</span><span class="o">)</span>                 <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="c1">// start singleton services</span>
    <span class="k">else</span>
        <span class="c1">// stop singleton services</span>
<span class="o">});</span></code></pre>
                    </div>
                </div>
                <div class="colist arabic">
                    <table>
                        <tr>
                            <td><i class="conum" data-value="1"></i><b>1</b></td>
                            <td>A <code>RaftHandle</code> is created over a channel</td>
                        </tr>
                        <tr>
                            <td><i class="conum" data-value="2"></i><b>2</b></td>
                            <td>A <code>RAFT.RoleChange</code> callback is registered with the handle. Alternatively, <code>addRoleListener()</code> could be called
                                directly on an instance of <code>RAFT</code> retrieved from the protocol stack associated with the given channel</td>
                        </tr>
                        <tr>
                            <td><i class="conum" data-value="3"></i><b>3</b></td>
                            <td>When we become the Raft leader, the singleton services can be started, when not, they should be stopped (if running)</td>
                        </tr>
                    </table>
                </div>
                <div class="paragraph">
                    <p>In jgroups-raft, utilizing JGroups' views and an altered leader election algorithm strengthens the singleton more than
                        the one described by Raft. In a usual Raft implementation, the members compete to become leaders based on time outs.
                        This behavior causes disruptions in the cluster, and it allows for multiple leaders at the same time but on different terms.</p>
                </div>
                <div class="paragraph">
                    <p>More details about the jgroups-raft custom election algorithm are available in the design documents. In a few words,
                        our implementation is more robust and less prone to disruption of competing members. These design changes converge in
                        a more stable singleton service.</p>
                </div>
                <div class="admonitionblock caution">
                    <table>
                        <tr>
                            <td class="icon">
                                <i class="fa icon-caution" title="Caution"></i>
                            </td>
                            <td class="content">
                                <div class="title">Singleton is <strong>not</strong> a distributed lock.</div>
                                <div class="paragraph">
                                    <p>Utilizing the singleton service as a distributed lock to access critical sections or resources is dangerous during
                                        network partitions. The current leader may split in a minority partition, which means the majority elects another node.
                                        If this happens while a node is in a critical section, it could result in two nodes accessing the resource.</p>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="sect1">
        <h2 id="protlist"><a class="anchor" href="#protlist"></a>4. List of protocols</h2>
        <div class="sectionbody">
            <div class="paragraph">
                <p>This chapter describes the most frequently used protocols, and their configuration.</p>
            </div>
            <div class="paragraph">
                <p>Meanwhile, we recommend that users should copy one of the predefined configurations (shipped with jgroups-raft), e.g.
                    raft.xml, and make only minimal changes to it.</p>
            </div>
            <div class="sect2">
                <h3 id="NO_DUPES"><a class="anchor" href="#NO_DUPES"></a>4.1. NO_DUPES</h3>
                <div class="paragraph">
                    <p>This protocol prevents duplicate members from joining the cluster. The protocol needs to be located somewhere below
                        <code>GMS</code>.</p>
                </div>
                <div class="paragraph">
                    <p><code>NO_DUPES</code> catches JOIN requests from a joiner to the JGroups coordinator and checks if the joiner&#8217;s <code>raft_id</code> is
                        already contained in the current membership, and rejects the JOIN if this is the case.</p>
                </div>
                <div class="paragraph">
                    <p>For example, if we have current members <code>{A,B}</code> and another member with <code>raft_id</code> "B" joins, then the joiner would
                        get the following exception when trying to join the cluster:</p>
                </div>
                <div class="listingblock">
                    <div class="content">
<pre>-------------------------------------------------------------------
GMS: address=B, cluster=cntrs, physical address=127.0.0.1:64733
-------------------------------------------------------------------
Exception in thread "main" java.lang.Exception: connecting to channel "cntrs" failed
	at org.jgroups.JChannel._connect(JChannel.java:570)
	at org.jgroups.JChannel.connect(JChannel.java:294)
	at org.jgroups.JChannel.connect(JChannel.java:279)
	at org.jgroups.raft.demos.CounterServiceDemo.start(CounterServiceDemo.java:32)
	at org.jgroups.raft.demos.CounterServiceDemo.main(CounterServiceDemo.java:163)
Caused by: java.lang.SecurityException: join of B rejected as it would create a view with duplicate members (current view: [B|1] (2) [B, A])
	at org.jgroups.protocols.pbcast.ClientGmsImpl.isJoinResponseValid(ClientGmsImpl.java:187)
	at org.jgroups.protocols.pbcast.ClientGmsImpl.installViewIfValidJoinRsp(ClientGmsImpl.java:153)
	at org.jgroups.protocols.pbcast.ClientGmsImpl.joinInternal(ClientGmsImpl.java:111)
	at org.jgroups.protocols.pbcast.ClientGmsImpl.join(ClientGmsImpl.java:41)
	at org.jgroups.protocols.pbcast.GMS.down(GMS.java:1087)
	at org.jgroups.protocols.FlowControl.down(FlowControl.java:353)
	at org.jgroups.protocols.FlowControl.down(FlowControl.java:353)
	at org.jgroups.protocols.FRAG2.down(FRAG2.java:136)
	at org.jgroups.protocols.RSVP.down(RSVP.java:153)
	at org.jgroups.protocols.pbcast.STATE_TRANSFER.down(STATE_TRANSFER.java:202)
	at org.jgroups.protocols.raft.ELECTION.down(ELECTION.java:112)
	at org.jgroups.protocols.raft.RAFT.down(RAFT.java:442)
	at org.jgroups.protocols.raft.REDIRECT.down(REDIRECT.java:103)
	at org.jgroups.stack.ProtocolStack.down(ProtocolStack.java:1038)
	at org.jgroups.JChannel.down(JChannel.java:791)
	at org.jgroups.JChannel._connect(JChannel.java:564)
	... 4 more
[mac] /Users/bela/jgroups-raft$</pre>
                    </div>
                </div>
                <div class="paragraph">
                    <p>The error message is <code>SecurityException: join of B rejected as it would create a view with duplicate members (current view: [B|1] (2) [B, A])</code>,
                        which shows that view <code>{B,A}</code> already contains a member with <code>raft_id</code> <code>B</code>, and so the JOIN request of the new member
                        is rejected.</p>
                </div>
            </div>
            <div class="sect2">
                <h3 id="ELECTION"><a class="anchor" href="#ELECTION"></a>4.2. ELECTION</h3>
                <div class="paragraph">
                    <p><code>ELECTION</code> is the protocol which performs leader election, as defined by Raft.
                        Its attributes define the election timeout and the heartbeat interval (see Raft for details).</p>
                </div>
                <table class="tableblock frame-all grid-all" style="width: 90%;">
                    <caption class="title">Table 1. ELECTION</caption>
                    <colgroup>
                        <col style="width: 16.6666%;">
                        <col style="width: 83.3334%;">
                    </colgroup>
                    <thead>
                    <tr>
                        <th class="tableblock halign-left valign-top">Name</th>
                        <th class="tableblock halign-left valign-top">Description</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">vote_timeout</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">Max time (ms) to wait for vote responses</p></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="sect2">
                <h3 id="ELECTION2"><a class="anchor" href="#ELECTION2"></a>4.3. ELECTION2</h3>
                <div class="paragraph">
                    <p><code>ELECTION2</code> is an alternative election algorithm.
                        It builds on top of <a href="#ELECTION">ELECTION</a> to include a pre-vote mechanism.
                        The pre-vote runs before delegating to the algorithm of <a href="#ELECTION">ELECTION</a>.</p>
                </div>
                <div class="paragraph">
                    <p>By design, <a href="#ELECTION">ELECTION</a> uses view changes to start election rounds and should be stable without interruptions.
                        <code>ELECTION2</code> is an alternative in networks with recurrent partitions that could lead to more disruptions with unnecessary election rounds.
                        More information about how it works is available in the design documents.</p>
                </div>
                <table class="tableblock frame-all grid-all" style="width: 90%;">
                    <caption class="title">Table 2. ELECTION2</caption>
                    <colgroup>
                        <col style="width: 16.6666%;">
                        <col style="width: 83.3334%;">
                    </colgroup>
                    <thead>
                    <tr>
                        <th class="tableblock halign-left valign-top">Name</th>
                        <th class="tableblock halign-left valign-top">Description</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">vote_timeout</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">Max time (ms) to wait for vote responses</p></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="sect2">
                <h3 id="RAFT"><a class="anchor" href="#RAFT"></a>4.4. RAFT</h3>
                <div class="paragraph">
                    <p><code>RAFT</code> is the main protocol in jgroups-raft; it implements log appending and committing, snapshotting and log compaction,
                        syncing of new members and so on.</p>
                </div>
                <table class="tableblock frame-all grid-all" style="width: 90%;">
                    <caption class="title">Table 3. RAFT</caption>
                    <colgroup>
                        <col style="width: 16.6666%;">
                        <col style="width: 83.3334%;">
                    </colgroup>
                    <thead>
                    <tr>
                        <th class="tableblock halign-left valign-top">Name</th>
                        <th class="tableblock halign-left valign-top">Description</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">dynamic_view_changes</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">If true, we can change 'members' at runtime</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">log_args</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">Arguments to the log impl, e.g. k1=v1,k2=v2. These will be passed to init()</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">log_class</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">The fully qualified name of the class implementing Log</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">log_dir</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">The directory in which the log and snapshots are stored. Defaults to the temp dir</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">log_prefix</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">The prefix of the log and snapshot. If null, the logical name of the channel is used as prefix</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">log_use_fsync</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">If true, a change is guaranteed to be written to disk when the call returns</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">max_log_cache_size</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">max_log_size</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">Max number of bytes a log can have until a snapshot is created</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">members</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">List of members (logical names); majority is computed from it</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">processing_queue_max_size</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">Max size in items the processing queue can have</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">raft_id</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">The identifier of this node. Needs to be unique and an element of members. Must not be null</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">resend_interval</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">Interval (ms) at which AppendEntries messages are resent to members with missing log entries</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">send_commits_immediately</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">Send commit message to followers immediately after leader commits (majority has consensus). Caution : it may generate more traffic than expected</p></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="sect2">
                <h3 id="REDIRECT"><a class="anchor" href="#REDIRECT"></a>4.5. REDIRECT</h3>
                <div class="paragraph">
                    <p>The <code>REDIRECT</code> protocol needs to be somewhere above <code>RAFT</code>. It keeps track of the current Raft leader and redirects
                        requests to the right leader. If there is no leader, e.g. because there&#8217;s no majority to elect one, an exception will
                        be thrown.</p>
                </div>
            </div>
            <div class="sect2">
                <h3 id="CLIENT"><a class="anchor" href="#CLIENT"></a>4.6. CLIENT</h3>
                <div class="paragraph">
                    <p><code>CLIENT</code> listens on a socket for client requests. When a request is received, it is sent down where it will be forwarded
                        (by <code>REDIRECT</code>) to the current leader which executes the request. The responses is then sent back to the client.</p>
                </div>
                <table class="tableblock frame-all grid-all" style="width: 90%;">
                    <caption class="title">Table 4. CLIENT</caption>
                    <colgroup>
                        <col style="width: 16.6666%;">
                        <col style="width: 83.3334%;">
                    </colgroup>
                    <thead>
                    <tr>
                        <th class="tableblock halign-left valign-top">Name</th>
                        <th class="tableblock halign-left valign-top">Description</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">bind_addr</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">The bind address which should be used by the server socket. The following special values are also recognized: GLOBAL, SITE_LOCAL, LINK_LOCAL, NON_LOOPBACK, match-interface, match-host, match-address</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">idle_time</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">Number of ms a thread can be idle before being removed from the thread pool</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">max_threads</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">Max number of threads in the thread pool</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">min_threads</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">The min threads in the thread pool</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">Port to listen for client requests</p></td>
                    </tr>
                    <tr>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">recv_buf_size</p></td>
                        <td class="tableblock halign-left valign-top"><p class="tableblock">Number of bytes of the server socket&#8217;s receive buffer</p></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="sect1">
        <h2 id="_migration_guide"><a class="anchor" href="#_migration_guide"></a>5. Migration Guide</h2>
        <div class="sectionbody">
            <div class="paragraph">
                <p>Guide to migrate your applications between different version.
                    JGroups Raft follows the usual semantic versioning for releases.
                    Patch releases should work out-of-the-box without further changes from the application&#8217;s perspective.
                    Major and minor might require some extra steps to continue working (migration scripts, public API updates, etc).</p>
            </div>
            <div class="sect2">
                <h3 id="_1_1_0"><a class="anchor" href="#_1_1_0"></a>5.1. 1.1.0</h3>
                <div class="paragraph">
                    <p>For users upgrading from 1.0.x to 1.1.x.</p>
                </div>
                <div class="sect3">
                    <h4 id="_leveldblog_is_deprecated"><a class="anchor" href="#_leveldblog_is_deprecated"></a>5.1.1. LevelDBLog is deprecated</h4>
                    <div class="paragraph">
                        <p>To remove the use of abandonware, we marked <code>LevelDBLog</code> as deprecated and its implementation now delegates to <code>FileBasedLog</code>.
                            Since these logs utilize different formats, a migration procedure is needed to keep your data intact.
                            We have developed a script utilizing <a href="https://www.jbang.dev/">JBang</a> to migrate from <code>LevelDBLog</code> to <code>FileBasedLog</code>.
                            This procedure will migrate the existing files to the expected format and keep the original data.</p>
                    </div>
                    <div class="paragraph">
                        <p>The migration script is located under the <code>bin</code> folder in the project root with name <code>migrate_leveldb.java</code>.
                            These scripts are not shipped with the release.
                            Suppose you utilized JGroups Raft with LevelDB pointing to folder <code>/home/raft/data</code>.
                            You can utilize the migration script as:</p>
                    </div>
                    <div class="listingblock">
                        <div class="content">
                            <pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>./bin/migrate_leveldb.java /home/raft/data</code></pre>
                        </div>
                    </div>
                    <div class="paragraph">
                        <p>This will read the data files at the given folder and transform to the expected format.
                            If the procedure fails during the migration, the new files will be cleaned up.
                            The new data will be placed in the same folder, so you can restart your application without changing properties.</p>
                    </div>
                    <div class="paragraph">
                        <p>If there is already data files with the format expected by the <code>FileBasedLog</code> the script will not run and exit.
                            To run the migration tool and ignore the existing files, use the <code>--force</code> flag when invoking the script.
                            This will copy the existing data to a <code>temp</code> folder (<code>/home/raft/data/temp</code>, using the previous example) and will proceed with the migration.
                            If there is a <code>temp</code> folder already, the script will not run.</p>
                    </div>
                    <div class="admonitionblock note">
                        <table>
                            <tr>
                                <td class="icon">
                                    <i class="fa icon-note" title="Note"></i>
                                </td>
                                <td class="content">
                                    JBang allows running remote scripts. See <a href="https://www.jbang.dev/documentation/guide/latest/usage.html#urls-from-trusted-sources">JBang</a> for more information.
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="footer">
    <div id="footer-text">
        Last updated 2025-09-26 17:36:52 -0300
    </div>
</div>
</body>
</html>